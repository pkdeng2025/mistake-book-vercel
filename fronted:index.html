<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“š AI æ™ºèƒ½é”™é¢˜æœ¬</title>
  <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    :root { --primary: #4361ee; --light: #f8f9fa; --dark: #212529; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body { background: #fafbff; color: var(--dark); padding: 20px; max-width: 800px; margin: 0 auto; }
    h1 { text-align: center; margin: 20px 0; color: var(--primary); }
    .form-group { margin: 16px 0; }
    label { display: block; margin-bottom: 6px; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
    textarea { min-height: 80px; resize: vertical; }
    button {
      background: var(--primary); color: white; border: none; padding: 12px 20px;
      border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%;
      transition: opacity 0.2s;
    }
    button:hover:not(.loading) { opacity: 0.9; }
    button.loading { background: #6c757d; cursor: not-allowed; }
    #previewImg { max-width: 100%; margin-top: 10px; display: none; border-radius: 6px; }
    .mistake-list { margin-top: 30px; }
    .mistake-card { background: white; padding: 16px; border-radius: 10px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .subject-tag { background: #e0e7ff; color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 14px; }
    img.mistake-img { max-width: 100%; margin: 10px 0; border: 1px solid #eee; border-radius: 4px; }
    .ai-feedback { background: #f0f9ff; padding: 12px; border-left: 4px solid var(--primary); margin-top: 10px; white-space: pre-wrap; }
    .export-btn { background: #4cc9f0; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ğŸ“š AI æ™ºèƒ½é”™é¢˜æœ¬</h1>

  <!-- æ·»åŠ é”™é¢˜è¡¨å• -->
  <div class="form-group">
    <label for="subject">å­¦ç§‘</label>
    <select id="subject">
      <option value="æ•°å­¦">æ•°å­¦</option>
      <option value="ç‰©ç†">ç‰©ç†</option>
      <option value="åŒ–å­¦">åŒ–å­¦</option>
      <option value="è‹±è¯­">è‹±è¯­</option>
      <option value="è¯­æ–‡">è¯­æ–‡</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>
  </div>

  <div class="form-group">
    <label for="question">é¢˜ç›®å†…å®¹</label>
    <textarea id="question" placeholder="è¯·è¾“å…¥é¢˜ç›®ï¼ˆæˆ–ä¸Šä¼ å›¾ç‰‡å OCR è¯†åˆ«ï¼‰"></textarea>
  </div>

  <div class="form-group">
    <label for="imageUpload">ä¸Šä¼ é¢˜ç›®æˆªå›¾ï¼ˆå¯é€‰ï¼‰</label>
    <input type="file" id="imageUpload" accept="image/*">
    <img id="previewImg" alt="é¢„è§ˆ">
    <div id="ocrStatus" style="font-size:14px; color:#666; margin-top:6px;"></div>
  </div>

  <div class="form-group">
    <label for="userAnswer">æˆ‘çš„ç­”æ¡ˆ</label>
    <textarea id="userAnswer" placeholder="å†™ä¸‹ä½ çš„è§£ç­”æˆ–é€‰æ‹©"></textarea>
  </div>

  <button id="saveBtn">ğŸ’¾ ä¿å­˜é”™é¢˜ï¼ˆè‡ªåŠ¨ AI æ‰¹æ”¹ï¼‰</button>

  <!-- é”™é¢˜åˆ—è¡¨ -->
  <div class="mistake-list" id="mistakeList"></div>

  <script>
    // =============== OCR åŠŸèƒ½ ===============
    document.getElementById('imageUpload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const preview = document.getElementById('previewImg');
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      
      const status = document.getElementById('ocrStatus');
      status.textContent = 'ğŸ” æ­£åœ¨è¯†åˆ«æ–‡å­—...';
      
      try {
        const { data: { text } } = await Tesseract.recognize(file, 'chi_sim+eng', {
          logger: m => console.log(m),
        });
        document.getElementById('question').value = text.trim();
        status.textContent = 'âœ… è¯†åˆ«å®Œæˆï¼';
      } catch (err) {
        status.textContent = 'âŒ è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
        console.error(err);
      }
    });

    // =============== AI æ‰¹æ”¹ API è°ƒç”¨ ===============
    async function getAIFeedback(question, userAnswer, imageBase64 = null) {
      // âš ï¸ æ›¿æ¢ä¸ºä½ çš„ Render åç«¯ URLï¼ˆéƒ¨ç½²åå¡«å†™ï¼‰
      const BACKEND_URL = "https://your-backend.onrender.com/grade";
      
      const res = await fetch(BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, user_answer: userAnswer, image: imageBase64 })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'AI æœåŠ¡å¼‚å¸¸');
      return data.ai_feedback;
    }

    // =============== ä¿å­˜é”™é¢˜ ===============
    async function saveMistake(subject, question, userAnswer, aiFeedback, imageData) {
      const mistakes = JSON.parse(localStorage.getItem(`mistakes_${subject}`) || '[]');
      mistakes.push({
        id: Date.now().toString(),
        question,
        userAnswer,
        aiFeedback,
        image: imageData,
        timestamp: new Date().toLocaleString()
      });
      localStorage.setItem(`mistakes_${subject}`, JSON.stringify(mistakes));
      renderMistakes(); // åˆ·æ–°åˆ—è¡¨
    }

    // =============== æ¸²æŸ“é”™é¢˜åˆ—è¡¨ ===============
    function renderMistakes() {
      const container = document.getElementById('mistakeList');
      container.innerHTML = '';
      
      ['æ•°å­¦', 'ç‰©ç†', 'åŒ–å­¦', 'è‹±è¯­', 'è¯­æ–‡', 'å…¶ä»–'].forEach(subject => {
        const mistakes = JSON.parse(localStorage.getItem(`mistakes_${subject}`) || '[]');
        if (mistakes.length === 0) return;
        
        const subjectDiv = document.createElement('div');
        subjectDiv.innerHTML = `<h2 style="margin:20px 0 10px 0;">ğŸ“‚ ${subject}</h2>`;
        container.appendChild(subjectDiv);
        
        mistakes.forEach(m => {
          const card = document.createElement('div');
          card.className = 'mistake-card';
          card.innerHTML = `
            <div><span class="subject-tag">${subject}</span> Â· ${m.timestamp}</div>
            <div><strong>é¢˜ç›®ï¼š</strong>${m.question.replace(/\n/g, '<br>')}</div>
            <div><strong>æˆ‘çš„ç­”æ¡ˆï¼š</strong>${m.userAnswer.replace(/\n/g, '<br>')}</div>
            ${m.image ? `<img class="mistake-img" src="${m.image}">` : ''}
            <div class="ai-feedback"><strong>ğŸ¤– AI æ‰¹æ”¹ï¼š</strong><br>${m.aiFeedback.replace(/\n/g, '<br>')}</div>
          `;
          container.appendChild(card);
        });
      });
    }

    // =============== ä¿å­˜æŒ‰é’®äº‹ä»¶ ===============
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const subject = document.getElementById('subject').value;
      const question = document.getElementById('question').value.trim();
      const userAnswer = document.getElementById('userAnswer').value.trim();
      const fileInput = document.getElementById('imageUpload');
      const file = fileInput.files[0];

      if (!question || !userAnswer) {
        alert('è¯·å¡«å†™é¢˜ç›®å’Œä½ çš„ç­”æ¡ˆï¼');
        return;
      }

      const btn = document.getElementById('saveBtn');
      btn.classList.add('loading');
      btn.textContent = 'ğŸ§  AI æ‰¹æ”¹ä¸­...';

      let imageData = null;
      if (file) {
        const reader = new FileReader();
        reader.onload = async () => {
          imageData = reader.result;
          try {
            const aiFeedback = await getAIFeedback(question, userAnswer, imageData);
            saveMistake(subject, question, userAnswer, aiFeedback, imageData);
            alert('âœ… é”™é¢˜å·²ä¿å­˜å¹¶æ‰¹æ”¹å®Œæˆï¼');
          } catch (err) {
            alert('âŒ AI æ‰¹æ”¹å¤±è´¥ï¼š' + err.message);
          } finally {
            resetForm(btn);
          }
        };
        reader.readAsDataURL(file);
      } else {
        try {
          const aiFeedback = await getAIFeedback(question, userAnswer);
          saveMistake(subject, question, userAnswer, aiFeedback, null);
          alert('âœ… é”™é¢˜å·²ä¿å­˜å¹¶æ‰¹æ”¹å®Œæˆï¼');
        } catch (err) {
          alert('âŒ AI æ‰¹æ”¹å¤±è´¥ï¼š' + err.message);
        } finally {
          resetForm(btn);
        }
      }
    });

    function resetForm(btn) {
      document.getElementById('question').value = '';
      document.getElementById('userAnswer').value = '';
      document.getElementById('imageUpload').value = '';
      document.getElementById('previewImg').style.display = 'none';
      document.getElementById('ocrStatus').textContent = '';
      btn.classList.remove('loading');
      btn.textContent = 'ğŸ’¾ ä¿å­˜é”™é¢˜ï¼ˆè‡ªåŠ¨ AI æ‰¹æ”¹ï¼‰';
    }

    // åˆå§‹åŒ–
    renderMistakes();
  </script>
</body>
</html>